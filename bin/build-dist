#!/bin/bash
set -e

[ -z "$HELPERS_ROOT" ] && export HELPERS_ROOT="$( cd "$( dirname "${BASH_SOURCE[0]}" )/.." && pwd )"
source "$HELPERS_ROOT/lib/debug.sh"
source "$HELPERS_ROOT/lib/util.bash"

BUILD_DIR=$1
export PERL5LIB=
PATH="$(dirname "$(which "$($MODERN_PERL -e'print $^X')")"):$PATH"
eval "$($HELPERS_ROOT/bin/local-lib)"

function auto-install {
  local command="$1"
  local run_log="$(mktemp -t run-log-XXXXXX)"
  local deps
  local last_deps
  local status=0
  [ -n "$HELPERS_DEBUG" ] && echo "Auto detecting prereqs for $command" 1>&2
  until $command >$run_log 2>&1; do
    status=$?
    deps="$(perl -lne'if (/\bCan'\''t locate (\S+)\.pm in \@INC/) { my $m = $1; $m =~ s{/}{::}g; print $m;} elsif (/^(\S+) version (\S+) required--this is only version /) { print "$1~$2" }' "$run_log")"
    [ -z "$deps" ]              && break
    [ "$deps" == "$last_deps" ] && break
    status=0
    $HELPERS_ROOT/bin/cpan-install $deps
    last_deps="$deps"
  done
  cat "$run_log"
  rm -f "$run_log"
  return $status
}

if [ -e 'dist.ini' ] && [ -n "$DIST_INKT_PROFILE" ]; then
  echo "Building with Dist::Inkt ($DIST_INKT_PROFILE)"
  $HELPERS_ROOT/bin/cpan-install ExtUtils::MakeMaker~6.31 Dist::Inkt "$DIST_INKT_PROFILE"
  distinkt-dist --TRAVIS --targetdir="$BUILD_DIR"
elif [ -e 'dist.ini' ]; then
  echo "Building with Dist::Zilla"
  $HELPERS_ROOT/bin/cpan-install ExtUtils::MakeMaker~6.31 Dist::Zilla
  AUTHOR_DEPS="$(dzil authordeps --missing --versions | grep -v '^inc::' | sed -e's/ = 0$//' -e's/ = /~/')"
  [ -n "$HELPERS_DEBUG" ] && echo "Author Deps: $AUTHOR_DEPS" 1>&2
  $HELPERS_ROOT/bin/cpan-install $AUTHOR_DEPS
  [ -n "$HELPERS_DEBUG" ] && echo "Prereqs installed. Building." 1>&2
  VERBOSE=""
  [ -n "$TRAVIS_PERL_DEBUG" ] && VERBOSE="-v"
  dzil build $VERBOSE --in="$BUILD_DIR" < /dev/null
elif [ -e 'Build.PL' ] && grep -q 'GENERATED BY MINILLA' 'Build.PL' || [ -e 'minil.toml' ]; then
  echo "Building with Minilla"
  $HELPERS_ROOT/bin/cpan-install Minilla
  minil dist --no-test
  mkdir "$BUILD_DIR"
  tar xzf "$(ls -t *.tar.gz | head -1)" --strip-components=1 -C "$BUILD_DIR"
elif [ -e 'Build.PL' ]; then
  echo "Building with Build.PL (Module::Build)"
  $HELPERS_ROOT/bin/cpan-install Module::Build~0.36
  auto-install "perl Build.PL" < /dev/null
  ./Build manifest
  ./Build distdir
  DIST_DIR=$(perl -e'my $d = (do "_build/build_params")->[2]; print "$d->{dist_name}-$d->{dist_version}\n"')
  mv "$DIST_DIR" "$BUILD_DIR"
elif [ -e 'Makefile.PL' ]; then
  if grep -q 'Module::Install' 'Makefile.PL'; then
    echo "Building with Makefile.PL (Module::Install)"
    AUTHOR_DEPS='ExtUtils::MakeMaker~6.31 Module::Install'
    while read command module; do
      grep -q -E "$command" 'Makefile.PL' && AUTHOR_DEPS="$AUTHOR_DEPS $module"
    done < $HELPERS_ROOT/share/module-install-commands.txt
    $HELPERS_ROOT/bin/cpan-install $AUTHOR_DEPS
  else
    echo "Building with Makefile.PL (ExtUtils::MakeMaker)"
  fi
  auto-install "perl Makefile.PL DISTVNAME=$BUILD_DIR" < /dev/null
  make manifest
  make distdir
else
  echo "Don't know how to build this dist!" >&2
  exit 1
fi
